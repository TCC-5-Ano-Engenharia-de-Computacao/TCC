<StateMachine initialState="Idle">

    <!-- ================== IDLE ================== -->
    <State id="Idle">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Idle"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <!-- Ataque leve: input “attack” -->
            <Transition to="WeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <!-- Ataque pesado: input “kick” -->
            <Transition to="StrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <!-- Pulo vertical -->
            <Transition to="Jump">
                <Conditions>
                    <BufferedInputCondition inputName="jump"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <!-- Andar pra frente -->
            <Transition to="WalkingFoward">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="66$"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <!-- Andar pra trás -->
            <Transition to="WalkingBackwards">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="4$"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <!-- Agachar -->
            <Transition to="CrouchStart">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="([123])$"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ============== WALKING FORWARD ============== -->
    <State id="WalkingFoward">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/WalkingFoward"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
            <MovePlayerAction speed="1" direction="forward"/>
        </OnStay>

        <Transitions>
            <Transition to="WeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="StrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <!-- Pulo diagonal para frente -->
            <Transition to="JumpForward">
                <Conditions>
                    <BufferedInputCondition inputName="jump"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <Transition to="Idle">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="[^6]$"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ============= WALKING BACKWARDS ============= -->
    <State id="WalkingBackwards">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/WalkingBackwards"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
            <MovePlayerAction speed="1" direction="backward"/>
        </OnStay>

        <Transitions>
            <Transition to="WeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="StrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <!-- Pulo diagonal para trás -->
            <Transition to="JumpBackward">
                <Conditions>
                    <BufferedInputCondition inputName="jump"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <Transition to="Idle">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="[^4]$"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== CROUCH START ================== -->
    <State id="CrouchStart">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/CrouchStart"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="CrouchIdle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="CrouchStart"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== CROUCH IDLE ================== -->
    <State id="CrouchIdle">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/CrouchIdle"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="CrouchWeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="CrouchStrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <Transition to="CrouchEnd">
                <Conditions>
                    <AnalogHistoryRegexCondition regexString="[^123]$"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== CROUCH END ================== -->
    <State id="CrouchEnd">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/CrouchEnd"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="Idle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="CrouchEnd"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== JUMP (vertical) ================== -->
    <State id="Jump">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Jump"/>
            <JumpPlayerAction force="50"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="JumpWeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="JumpStrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <Transition to="Rise">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Jump"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== JUMP FORWARD ================== -->
    <State id="JumpForward">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Jump"/>
            <JumpPlayerAction force="50"/>
        </OnEnter>

        <OnStay>
            <MovePlayerAction speed="1" direction="forward"/>
        </OnStay>

        <Transitions>
            <Transition to="JumpWeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="JumpStrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <Transition to="Rise">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Jump"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== JUMP BACKWARD ================== -->
    <State id="JumpBackward">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Jump"/>
            <JumpPlayerAction force="50"/>
        </OnEnter>

        <OnStay>
            <MovePlayerAction speed="1" direction="backward"/>
        </OnStay>

        <Transitions>
            <Transition to="JumpWeakPunch">
                <Conditions>
                    <BufferedInputCondition inputName="attack"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>
            <Transition to="JumpStrongPunch">
                <Conditions>
                    <BufferedInputCondition inputName="kick"
                                            isInstantaneous="true"
                                            removeInputOnEndOfFrame="true"/>
                </Conditions>
            </Transition>

            <Transition to="Rise">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Jump"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== RISE ================== -->
    <State id="Rise">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Rise"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <!-- Se tocar o chão antes de cair, vai para Landing -->
            <Transition to="Landing">
                <Conditions>
                    <PlayerIsGroundedCondition/>
                    <PlayerIsNotFallingCondition/>
                </Conditions>
            </Transition>

            <!-- Começou a cair -->
            <Transition to="Apex">
                <Conditions>
                    <PlayerIsFallingCondition/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== APEX ================== -->
    <State id="Apex">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Apex"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <!-- Se tocar o chão direto do Apex -->
            <Transition to="Landing">
                <Conditions>
                    <PlayerIsGroundedCondition/>
                </Conditions>
            </Transition>

            <Transition to="Falling">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Apex"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== FALLING ================== -->
    <State id="Falling">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Falling"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="Landing">
                <Conditions>
                    <PlayerIsGroundedCondition/>
                    <PlayerIsNotFallingCondition/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== LANDING ================== -->
    <State id="Landing">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Landing"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="Idle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Landing"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ============== STANDING ATTACKS ============== -->
    <State id="WeakPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/WeakPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="Idle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="WeakPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <State id="StrongPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/StrongPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="Idle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="StrongPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ============== CROUCH ATTACKS ============== -->
    <State id="CrouchWeakPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/WeakPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="CrouchIdle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="WeakPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <State id="CrouchStrongPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/StrongPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="CrouchIdle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="StrongPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ============== AIR ATTACKS ============== -->
    <State id="JumpWeakPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/WeakPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="Rise">
                <Conditions>
                    <AnimationReachedEndCondition clipName="WeakPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <State id="JumpStrongPunch">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/StrongPunch"/>
        </OnEnter>

        <OnStay>
        </OnStay>

        <Transitions>
            <Transition to="Rise">
                <Conditions>
                    <AnimationReachedEndCondition clipName="StrongPunch"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

    <!-- ================== KNOCKBACK ================== -->
    <State id="Knockback">
        <OnEnter>
            <PlayAnimationClipAction animationClipAddress="Animations/Knockback"/>
        </OnEnter>

        <OnStay>
            <UpdateSideAction/>
        </OnStay>

        <Transitions>
            <Transition to="Idle">
                <Conditions>
                    <AnimationReachedEndCondition clipName="Knockback"/>
                </Conditions>
            </Transition>
        </Transitions>
    </State>

</StateMachine>
